# パフォーマンスチューニングガイド

NanaSQLiteは、標準構成でも高速に動作するように設計されていますが、適切な開発パターンと設定を選択することで、その性能を数倍〜数十倍に引き出すことが可能です。

---

## 🚀 核心となる最適化: バッチ操作の活用

SQLiteにおいて最も実行コストが高いのは「トランザクションの開始とコミット」です。

### ❌ アンチパターン: ループ内での個別書き込み
以下のコードは、1回のループごとにディスクI/Oが発生するため非常に低速です。
```python
# 1000回のディスクコミットが発生（数秒〜数十秒かかる場合がある）
for i in range(1000):
    db[f"key_{i}"] = i
```

### ✅ 推奨パターン: `batch_update` / `batch_get`
NanaSQLiteのバッチ操作用メソッドを使用すると、1回のトランザクションでまとめて処理されるため、劇的に高速化します。
```python
# 1回のディスクコミットで完了（ミリ秒単位で終了）
data = {f"key_{i}": i for i in range(1000)}
db.batch_update(data)
```

**ベンチマーク指標**: 大量書き込みにおいて、個別更新に比べ **10倍〜100倍以上** の高速化が期待できます。

---

## ⚡ データベース設定の最適化

### WAL (Write-Ahead Logging) モード
NanaSQLiteはデフォルトで `optimize=True` 設定時に **WALモード** を有効にします。
- **メリット**: 書き込み中も読み込みがブロックされず、並行性が向上します。
- **注意**: ネットワークドライブ（NFS/SMB）上ではWALモードが動作しない、または不安定になる場合があります。

### メモリマップドI/O (mmap)
読み込みパフォーマンスを向上させるために、SQLiteの `mmap_size` を活用しています。デフォルトでは256MBが割り当てられています。

---

## 🧠 キャッシュ戦略

NanaSQLiteは「遅延ロード型」のメモリキャッシュを搭載しています。

1.  **bulk_load=True (初期化時)**:
    -   起動時に全データをメモリに読み込みます。
    -   **ユースケース**: データ量が数万件程度で、起動直後から高速なランダムアクセスが必要な場合。
2.  **デフォルト (遅延ロード)**:
    -   アクセスされたデータのみをメモリに保持します。
    -   **ユースケース**: データ量が巨大で、メモリ使用量を抑えたい場合。

> [!TIP]
> キャッシュをリフレッシュしたい場合は `db.refresh()` または `db.get_fresh(key)` を使用してください。

---

## 🔍 インデックスによる検索の高速化

`query()` や `query_with_pagination()` を使用して、Key-Valueペア以外のデータ（JSON内の特定フィールドなど）を検索する場合、インデックスが不可欠です。

```python
# 検索対象となるJSONフィールドにインデックスを貼る
db.create_index("idx_user_age", "data", ["age"])
```

**インデックス作成の目安**:
- 数千件を超えるデータに対して `WHERE` 句での検索を頻繁に行う場合。
- データの挿入速度よりも検索速度を優先したい場合。

---

## 💻 OS・環境固有の注意点

### Windows環境
- **アンチウイルスソフト**: SQLiteファイルの書き込み時にウイルススキャンが走ると、`database is locked` が発生しやすくなります。DBファイル（.db, .db-wal, .db-shm）をスキャン除外対象に設定することを推奨します。

### SSD vs HDD
- SQLiteはディスクの「シーク」に敏感です。HDD環境では `synchronous=OFF`（データ紛失リスクあり）などの極端な設定が必要になる場合がありますが、可能な限り **SSD** での運用を推奨します。

---

## チェックリスト
- [ ] 大量処理に `batch_update` を使っているか？
- [ ] 頻繁な検索に `create_index` を適用しているか？
- [ ] `optimize=True`（デフォルト）を使用しているか？
- [ ] SSD環境で動作させているか？
