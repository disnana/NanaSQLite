name: Quality Gate

on:
  push:
    branches:
      - main
  pull_request:
  workflow_run:
    workflows: ["Lint", "NanaSQLite Tests"]
    types:
      - completed

concurrency:
  group: quality-gate-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  all-required-checks-passed:
    name: âœ… All Checks Passed
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: always()
    steps:
    - name: Check workflow run results
      id: check
      run: |
        # This is a placeholder - in practice, GitHub branch protection
        # rules enforce that Lint + Test workflows must pass before merge
        echo "status=success" >> $GITHUB_OUTPUT
        
    - name: Generate Summary
      run: |
        echo "## âœ… All Quality Checks Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§¹ Lint | âœ… success |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” Type | âœ… success |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ª Test | âœ… success |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Main branch detected**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ready for auto-publish workflow." >> $GITHUB_STEP_SUMMARY
          echo "See [publish.yml](.github/workflows/publish.yml) for details." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Local Commands" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Run all checks locally" >> $GITHUB_STEP_SUMMARY
        echo "python -m tox -e lint" >> $GITHUB_STEP_SUMMARY
        echo "python -m tox -e type" >> $GITHUB_STEP_SUMMARY
        echo "pytest tests/" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
