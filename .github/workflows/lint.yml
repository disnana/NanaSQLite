name: Lint

on:
  push:
    branches-ignore:
      - main
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'tox.ini'
      - '.github/workflows/lint.yml'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'tox.ini'
      - '.github/workflows/lint.yml'

concurrency:
  group: lint-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Ruff Linter
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"
    
    - name: Install tox
      run: pip install tox
    
    - name: Run python -m tox -e lint
      env:
        FORCE_COLOR: 1
        TOX_TESTENV_PASSENV: FORCE_COLOR
      run: python -m tox -e lint

  type:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"
    
    - name: Install tox
      run: pip install tox
    
    - name: Run python -m tox -e type
      env:
        FORCE_COLOR: 1
        TOX_TESTENV_PASSENV: FORCE_COLOR
      run: python -m tox -e type

  summary:
    name: Lint Summary
    needs: [lint, type]
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: always()
    steps:
    - name: Generate Summary
      run: |
        echo "## ðŸ” Code Quality Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        
        # Lint status
        if [ "${{ needs.lint.result }}" == "success" ]; then
          echo "| ðŸ§¹ Ruff Lint | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ§¹ Ruff Lint | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Type status
        if [ "${{ needs.type.result }}" == "success" ]; then
          echo "| ðŸ” Type Check (mypy) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ” Type Check (mypy) | âš ï¸ Issues found |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Quick Commands" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Run locally" >> $GITHUB_STEP_SUMMARY
        echo "python -m tox -e lint    # Ruff linter" >> $GITHUB_STEP_SUMMARY
        echo "python -m tox -e type    # mypy type check" >> $GITHUB_STEP_SUMMARY
        echo "python -m tox -e fix     # Auto-fix issues" >> $GITHUB_STEP_SUMMARY
        echo "python -m tox -e format  # Format code" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
