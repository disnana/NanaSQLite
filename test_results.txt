============================= test session starts =============================
platform win32 -- Python 3.11.9, pytest-8.4.2, pluggy-1.5.0 -- C:\Program Files\Python311\python.exe
cachedir: .pytest_cache
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: D:\data-backup\code\コード保存\NanaSQLite
configfile: pyproject.toml
plugins: langsmith-0.4.38, asyncio-0.26.0, benchmark-5.1.0, socket-0.7.0, typeguard-4.4.4, anyio-4.9.0
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 8 items

tests/test_security_v120.py::test_sql_validation_strict_mode FAILED      [ 12%]
tests/test_security_v120.py::test_sql_validation_warning_mode FAILED     [ 25%]
tests/test_security_v120.py::test_allowed_sql_functions_init FAILED      [ 37%]
tests/test_security_v120.py::test_allowed_sql_functions_query FAILED     [ 50%]
tests/test_security_v120.py::test_forbidden_sql_functions FAILED         [ 62%]
tests/test_security_v120.py::test_override_allowed FAILED                [ 75%]
tests/test_security_v120.py::test_redos_protection FAILED                [ 87%]
tests/test_security_v120.py::test_connection_closed_error FAILED         [100%]
tests/test_security_v120.py::test_connection_closed_error ERROR          [100%]

=================================== ERRORS ====================================
______________ ERROR at teardown of test_connection_closed_error ______________
tests\test_security_v120.py:15: in teardown_module
    os.remove(DB_PATH)
E   PermissionError: [WinError 32] プロセスはファイルにアクセスできません。別のプロセスが使用中です。: 'test_security.db'
================================== FAILURES ===================================
_______________________ test_sql_validation_strict_mode _______________________
tests\test_security_v120.py:25: in test_sql_validation_strict_mode
    db.query(columns=["DANGEROUS_FUNC(*)"])
src\nanasqlite\core.py:1049: in query
    self._validate_expression(col, strict_sql_validation, allowed_sql_functions, forbidden_sql_functions, override_allowed)
src\nanasqlite\core.py:293: in _validate_expression
    raise NanaSQLiteValidationError(msg)
          ^^^^^^^^^^^^^^^^^^^^^^^^^
E   NameError: name 'NanaSQLiteValidationError' is not defined
______________________ test_sql_validation_warning_mode _______________________
src\nanasqlite\core.py:857: in execute
    return self._connection.execute(sql)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
D:\a\apsw\apsw\src\cursor.c:1196: in APSWCursor_execute.sqlite3_prepare_v3
    ???
E   apsw.SQLError: no such function: DANGEROUS_FUNC

During handling of the above exception, another exception occurred:
tests\test_security_v120.py:33: in test_sql_validation_warning_mode
    db.query(columns=["DANGEROUS_FUNC(*)"])
src\nanasqlite\core.py:1085: in query
    cursor = self.execute(sql, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\nanasqlite\core.py:861: in execute
    raise NanaSQLiteDatabaseError(f"Failed to execute SQL: {e}", original_error=e) from e
          ^^^^^^^^^^^^^^^^^^^^^^^
E   NameError: name 'NanaSQLiteDatabaseError' is not defined
_______________________ test_allowed_sql_functions_init _______________________
src\nanasqlite\core.py:857: in execute
    return self._connection.execute(sql)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
D:\a\apsw\apsw\src\cursor.c:1196: in APSWCursor_execute.sqlite3_prepare_v3
    ???
E   apsw.SQLError: no such function: MY_CUSTOM_FUNC

During handling of the above exception, another exception occurred:
tests\test_security_v120.py:40: in test_allowed_sql_functions_init
    db.query(columns=["MY_CUSTOM_FUNC(*)"])
src\nanasqlite\core.py:1085: in query
    cursor = self.execute(sql, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\nanasqlite\core.py:861: in execute
    raise NanaSQLiteDatabaseError(f"Failed to execute SQL: {e}", original_error=e) from e
          ^^^^^^^^^^^^^^^^^^^^^^^
E   NameError: name 'NanaSQLiteDatabaseError' is not defined
______________________ test_allowed_sql_functions_query _______________________
tests\test_security_v120.py:48: in test_allowed_sql_functions_query
    db.query(columns=["LOCAL_FUNC(*)"])
src\nanasqlite\core.py:1049: in query
    self._validate_expression(col, strict_sql_validation, allowed_sql_functions, forbidden_sql_functions, override_allowed)
src\nanasqlite\core.py:293: in _validate_expression
    raise NanaSQLiteValidationError(msg)
          ^^^^^^^^^^^^^^^^^^^^^^^^^
E   NameError: name 'NanaSQLiteValidationError' is not defined
________________________ test_forbidden_sql_functions _________________________
src\nanasqlite\core.py:857: in execute
    return self._connection.execute(sql)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
D:\a\apsw\apsw\src\cursor.c:1196: in APSWCursor_execute.sqlite3_prepare_v3
    ???
E   apsw.SQLError: no such function: SOME_FUNC

During handling of the above exception, another exception occurred:
tests\test_security_v120.py:58: in test_forbidden_sql_functions
    db.query(columns=["SOME_FUNC(*)"])
src\nanasqlite\core.py:1085: in query
    cursor = self.execute(sql, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\nanasqlite\core.py:861: in execute
    raise NanaSQLiteDatabaseError(f"Failed to execute SQL: {e}", original_error=e) from e
          ^^^^^^^^^^^^^^^^^^^^^^^
E   NameError: name 'NanaSQLiteDatabaseError' is not defined
____________________________ test_override_allowed ____________________________
src\nanasqlite\core.py:857: in execute
    return self._connection.execute(sql)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
D:\a\apsw\apsw\src\cursor.c:1196: in APSWCursor_execute.sqlite3_prepare_v3
    ???
E   apsw.SQLError: no such function: FUNC_A

During handling of the above exception, another exception occurred:
tests\test_security_v120.py:69: in test_override_allowed
    db.query(columns=["FUNC_A(*)"])
src\nanasqlite\core.py:1085: in query
    cursor = self.execute(sql, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\nanasqlite\core.py:861: in execute
    raise NanaSQLiteDatabaseError(f"Failed to execute SQL: {e}", original_error=e) from e
          ^^^^^^^^^^^^^^^^^^^^^^^
E   NameError: name 'NanaSQLiteDatabaseError' is not defined
____________________________ test_redos_protection ____________________________
src\nanasqlite\core.py:857: in execute
    return self._connection.execute(sql)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
D:\a\apsw\apsw\src\cursor.c:1196: in APSWCursor_execute.sqlite3_prepare_v3
    ???
E   apsw.SQLError: no such column: id

During handling of the above exception, another exception occurred:
tests\test_security_v120.py:83: in test_redos_protection
    db.query(where="id = 1")
src\nanasqlite\core.py:1085: in query
    cursor = self.execute(sql, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\nanasqlite\core.py:861: in execute
    raise NanaSQLiteDatabaseError(f"Failed to execute SQL: {e}", original_error=e) from e
          ^^^^^^^^^^^^^^^^^^^^^^^
E   NameError: name 'NanaSQLiteDatabaseError' is not defined
________________________ test_connection_closed_error _________________________
tests\test_security_v120.py:93: in test_connection_closed_error
    child = db.table("slave")
            ^^^^^^^^^^^^^^^^^
src\nanasqlite\core.py:1927: in table
    self._child_instances.append(weakref.ref(child))
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'WeakSet' object has no attribute 'append'
=========================== short test summary info ===========================
FAILED tests/test_security_v120.py::test_sql_validation_strict_mode - NameErr...
FAILED tests/test_security_v120.py::test_sql_validation_warning_mode - NameEr...
FAILED tests/test_security_v120.py::test_allowed_sql_functions_init - NameErr...
FAILED tests/test_security_v120.py::test_allowed_sql_functions_query - NameEr...
FAILED tests/test_security_v120.py::test_forbidden_sql_functions - NameError:...
FAILED tests/test_security_v120.py::test_override_allowed - NameError: name '...
FAILED tests/test_security_v120.py::test_redos_protection - NameError: name '...
FAILED tests/test_security_v120.py::test_connection_closed_error - AttributeE...
ERROR tests/test_security_v120.py::test_connection_closed_error - PermissionE...
========================= 8 failed, 1 error in 0.61s ==========================
