# potential_issues_proposal.md への対処計画と実装状況

**作成日**: 2025年12月18日  
**対象バージョン**: v1.1.0以降  
**ドキュメント**: docs/ja/potential_issues_proposal.md

---

## 概要

このドキュメントでは、`potential_issues_proposal.md`で指摘された潜在的な問題点に対する対処状況と今後の計画をまとめています。

---

## 実装済みの改善

### ✅ 1. カスタム例外クラスの導入（優先度: 高）

**問題点**: エラーハンドリングの不統一（セクション 2.1）

**対処内容**:
- `src/nanasqlite/exceptions.py`を新規作成
- 以下の例外クラスを実装:
  - `NanaSQLiteError` (基底クラス)
  - `NanaSQLiteValidationError` (バリデーションエラー)
  - `NanaSQLiteDatabaseError` (データベース操作エラー)
  - `NanaSQLiteTransactionError` (トランザクション関連エラー)
  - `NanaSQLiteConnectionError` (接続エラー)
  - `NanaSQLiteLockError` (ロックエラー、将来用)
  - `NanaSQLiteCacheError` (キャッシュエラー、将来用)

**変更箇所**:
- `src/nanasqlite/exceptions.py`: 新規作成
- `src/nanasqlite/core.py`: カスタム例外を使用
- `src/nanasqlite/__init__.py`: 例外クラスをエクスポート

**ドキュメント**:
- `docs/ja/error_handling.md`: エラーハンドリングガイドを作成（日本語）
- `docs/en/error_handling.md`: エラーハンドリングガイドを作成（英語）

**影響**:
- ユーザーは特定の例外タイプをキャッチして適切に処理可能
- エラーメッセージがより明確に
- 後方互換性は維持（既存の`ValueError`等も継続使用可能）

---

### ✅ 2. トランザクション管理の強化（優先度: 高）

**問題点**: トランザクションのネスト検出がない

**対処内容**:
- トランザクション状態の追跡:
  - `_in_transaction`: トランザクション中かどうか
  - `_transaction_depth`: ネストレベル（警告用）
- ネストしたトランザクションの検出とエラー発生
- トランザクション状態を確認する`in_transaction()`メソッドの追加
- トランザクション中の接続クローズを防止

**変更箇所**:
- `src/nanasqlite/core.py`:
  - `__init__`: トランザクション状態変数の追加
  - `begin_transaction()`: ネスト検出
  - `commit()`: トランザクション外でのコミットを検出
  - `rollback()`: トランザクション外でのロールバックを検出
  - `in_transaction()`: 新規メソッド
  - `close()`: トランザクション中のクローズを防止

**ドキュメント**:
- `docs/ja/transaction_guide.md`: トランザクションガイドを作成（日本語）
- `docs/en/transaction_guide.md`: トランザクションガイドを作成（英語）

**影響**:
- トランザクションの誤用を防止
- デバッグが容易に
- データの整合性が向上

---

### ✅ 3. リソースリーク対策（優先度: 高）

**問題点**: 子インスタンスの追跡とリソース管理（セクション 2.2）

**対処内容**:
- 親インスタンスが子インスタンスを弱参照で追跡
- 親が閉じられた際、子インスタンスに通知
- 孤立した子インスタンスの使用を防止

**変更箇所**:
- `src/nanasqlite/core.py`:
  - `__init__`: `_child_instances`, `_is_closed`, `_parent_closed`の追加
  - `_check_connection()`: 接続状態のチェック
  - `_mark_parent_closed()`: 親からの通知を受け取る
  - `table()`: 子インスタンスを追跡
  - `close()`: 子インスタンスに通知

**影響**:
- メモリリークの防止
- リソースの適切な管理
- より明確なエラーメッセージ

---

### ✅ 4. 非同期版トランザクション対応（優先度: 中）

**問題点**: AsyncNanaSQLiteにトランザクションメソッドがない

**対処内容**:
- 非同期トランザクションメソッドの実装:
  - `begin_transaction()`
  - `commit()`
  - `rollback()`
  - `in_transaction()`
  - `transaction()` (コンテキストマネージャ)
- `_AsyncTransactionContext`クラスの実装

**変更箇所**:
- `src/nanasqlite/async_core.py`: トランザクションメソッドを追加

**影響**:
- 非同期アプリケーションでもトランザクションが使用可能
- 同期版と同じAPIで一貫性のある操作

---

### ✅ 5. エラーハンドリングの改善

**問題点**: エラーメッセージの不明瞭さ

**対処内容**:
- `execute()`メソッドにエラーハンドリングを追加
- APSWの例外を`NanaSQLiteDatabaseError`でラップ
- 元のエラー情報を保持(`original_error`属性)
- 接続状態のチェックを各メソッドに追加

**変更箇所**:
- `src/nanasqlite/core.py`: 
  - `execute()`: エラーハンドリングの追加
  - `_sanitize_identifier()`: ValidationErrorを使用

**影響**:
- より分かりやすいエラーメッセージ
- デバッグが容易に
- エラーの原因を特定しやすい

---

## 今後の対応予定

### 🟡 6. SQLインジェクション対策の強化（優先度: 高）

**問題点**: 列名検証の不統一（セクション 1.1）

**計画**:
- `_validate_column_expression()`メソッドの実装
- 許可される関数のホワイトリスト
- AS句の適切な検証
- 複雑なSQL式のサポート

**実装予定**: v1.2.0

**影響**:
- セキュリティの向上
- より複雑なクエリのサポート

---

### 🟡 7. ReDoS対策（優先度: 中）

**問題点**: 正規表現DoS攻撃への脆弱性（セクション 1.2）

**計画**:
- 入力長の制限（`MAX_CLAUSE_LENGTH = 1000`）
- 正規表現をシンプルな文字チェックに置き換え
- タイムアウト機構の追加

**実装予定**: v1.2.0

**影響**:
- DoS攻撃への耐性向上
- より安全な運用

---

### 🟡 8. キャッシュ戦略の改善（優先度: 中）

**問題点**: キャッシュサイズの制限がない（セクション 3.1）

**計画**:
- LRUキャッシュの実装
- キャッシュサイズの上限設定
- キャッシュのメトリクス収集

**実装予定**: v1.3.0

**コード例**:
```python
db = NanaSQLite("mydata.db", cache_strategy="lru", max_cache_size=1000)
```

**影響**:
- メモリ使用量の制御
- 大規模データセットでの安定性向上

---

### 🟡 9. バルク操作の拡張（優先度: 中）

**問題点**: `batch_get()`がない（セクション 3.2）

**計画**:
- `batch_get(keys: List[str]) -> Dict[str, Any]`の実装
- 1回のクエリで複数のキーを取得
- N+1問題の解消

**実装予定**: v1.2.0

**コード例**:
```python
# 効率的な一括取得
results = db.batch_get(["user1", "user2", "user3"])
```

**影響**:
- パフォーマンスの向上（特に大量のキーを取得する場合）
- ネットワーク経由でのアクセスでの効率化

---

### 🟢 10. ドキュメントの充実（優先度: 中）

**問題点**: APIドキュメントの自動生成がない（セクション 6.1）

**計画**:
- Sphinxのセットアップ
- ReadTheDocsとの連携
- 型ヒントベースの自動生成

**実装予定**: v1.2.0

**影響**:
- ドキュメントの保守性向上
- ユーザーへの情報提供の改善

---

### 🟢 11. トラブルシューティングガイドの作成（優先度: 中）

**問題点**: よくある問題の解決方法が文書化されていない（セクション 6.3）

**ステータス**: 一部完成
- `docs/ja/error_handling.md`に基本的なトラブルシューティングを含む

**追加予定**:
- より詳細なトラブルシューティング
- パフォーマンスチューニングガイド
- 移行ガイド

**実装予定**: v1.2.0

---

### 🟢 12. タイムアウト機構の追加（優先度: 中）

**問題点**: ロック取得のタイムアウトがない（セクション 2.4）

**計画**:
- `TimeoutLock`クラスの実装
- タイムアウト付きロック取得
- デッドロック検出

**実装予定**: v1.3.0

**コード例**:
```python
db = NanaSQLite("mydata.db", lock_timeout=30.0)
```

**影響**:
- デッドロックの防止
- より堅牢なエラーハンドリング

---

## 低優先度の改善

### 🟢 13. 型ヒントの改善（優先度: 低）

**問題点**: ジェネリック型のサポート不足（セクション 2.3）

**計画**:
- `@overload`デコレータの使用
- TypeVarとGenericの活用
- より正確な型ヒント

**実装予定**: v1.4.0

---

### 🟢 14. API命名の統一（優先度: 低）

**問題点**: `sql_`プレフィックスの不統一（セクション 4.1）

**計画**:
- 新しいAPIの設計
- 既存APIの非推奨化（段階的）
- マイグレーションガイドの作成

**実装予定**: v2.0.0（破壊的変更として）

---

### 🟢 15. インデックス最適化機能（優先度: 低）

**問題点**: 自動的なインデックス推奨がない（セクション 3.3）

**計画**:
- `QueryAnalyzer`クラスの実装
- EXPLAIN QUERY PLANの分析
- インデックス推奨の生成

**実装予定**: v1.4.0

---

## テスト状況

### 実施済みのテスト

- ✅ 基本的な操作テスト（350件以上）
- ✅ 非同期操作テスト
- ✅ トランザクションテスト
- ✅ エラーハンドリングテスト
- ✅ 並行書き込みテスト

### 追加予定のテスト

- ⏳ エッジケーステスト
  - 極端に大きなデータ（100MB以上）
  - Unicode境界値（サロゲートペア、絵文字）
  - ディスクフル時の動作
  - ファイルシステム権限エラー
- ⏳ パフォーマンステスト
  - 継続的なベンチマーク
  - リグレッション検出
- ⏳ セキュリティテスト
  - ファジングテスト
  - 動的解析

---

## まとめ

### 完了した改善（v1.1.0）

1. ✅ カスタム例外クラスの導入
2. ✅ トランザクション管理の強化
3. ✅ リソースリーク対策
4. ✅ 非同期版トランザクション対応
5. ✅ エラーハンドリングの改善
6. ✅ エラーハンドリングガイドの作成（日本語・英語）
7. ✅ トランザクションガイドの作成（日本語・英語）
8. ✅ README.mdへの反映（トランザクション、エラーハンドリング、非同期トランザクション）
9. ✅ CHANGELOG.mdへの反映（v1.1.0の全変更内容）
10. ✅ テストの追加（21件のテスト、すべて合格）

### 次のマイルストーン（v1.2.0）

1. SQLインジェクション対策の強化
2. ReDoS対策
3. `batch_get()`の実装
4. ドキュメントの自動生成
5. トラブルシューティングガイドの拡充

### 将来のバージョン

- v1.3.0: キャッシュ戦略の改善、タイムアウト機構
- v1.4.0: インデックス最適化機能、型ヒントの改善
- v2.0.0: API命名の統一（破壊的変更）

---

## 参考資料

- [potential_issues_proposal.md](../../docs/ja/potential_issues_proposal.md)
- [error_handling.md](../../docs/ja/error_handling.md)
- [transaction_guide.md](../../docs/ja/transaction_guide.md)
- [CHANGELOG.md](../../CHANGELOG.md)

---

**最終更新日**: 2025年12月18日

